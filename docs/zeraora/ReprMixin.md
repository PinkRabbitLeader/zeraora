# ReprMixin

生成特定格式的[representation](https://docs.python.org/zh-cn/3/library/functions.html#repr)，包括类名，可选的主键、标签、属性。

```xml
<SstudentInfo(12) female username="leo" joined=2022 birthday=[2000-01-23]>
```

## 用法

直接将其作为第一父类继承，然后通过在内部类 `TagMeta` 和 `AttributeMeta` 添加变量来创建标签以及字段的representation。

会按照变量定义顺序来排序。

```Python
from datetime import date
from django.db import models
from zeraora.utils import ReprMixin

def _grade(join_date: date) -> str:
    """
    将入学日期转换为年级，并以字符串类型返回。
    """
    today = date(2023, 9, 1)
    years = today.year - join_date.year + 1
    return str(years)

class Student(ReprMixin, models.Model):
    """
    学生信息（数据库模型）
    """
    name = models.CharField(max_length=150)
    birth = models.DateField()
    female = models.BooleanField(default=False)
    leader = models.BooleanField(default=False)
    joined = models.DateField()

    class TagMeta:
        female = 'male', 'female'  # 分别为 False、True 时显示
        leader = 'leader'  # 仅为 True 时显示

    class AttributeMeta:
        name = 'name'
        birth = 'birth'
        joined: _grade = 'grade'  # 相当于 _grade(self.joined)

amy = Student(
    name='amy', birth=date(2012, 1, 23), id=1,
    female=True, joined=date(2020, 9, 1),
)
print(repr(amy))
# <Student(1) female name="amy" birth=[2012-01-23] grade=4>

jim = Student(
    name='jim', birth=date(2013, 6, 1), id=2,
    leader=True, joined=date(2021, 9, 1),
)
print(repr(jim))
# <Student(2) male leader name="jim" birth=[2013-06-01] grade=3>
```

`TagMeta` 的变量可以直接赋予映射关系：

```Python
from django.db import models
from zeraora.utils import ReprMixin

SUBJECTS = ['工学', '哲学', '法学', '文学', '理学', '农学', '医学',
            '经济学', '教育学', '历史学', '管理学', '军事学', '艺术学']

class Grade(models.IntegerChoices):
    FRESHMAN = 1, 'Freshman'
    SOPHOMORE = 2, 'Sophomore'
    JUNIOR = 3, 'Junior'
    SENIOR = 4, 'Senior'

class Student(ReprMixin, models.Model):
    """
    学生信息。
    """
    name = models.CharField(max_length=150)
    grade = models.IntegerField(choices=Grade.choices)
    subject = models.IntegerField()

    class TagMeta:
        grade = dict(Grade.choices)
        subject = SUBJECTS

    class AttributeMeta:
        name = 'name'

leo = Student(
    id=3, name='leo', grade=Grade.JUNIOR, subject=1
)
print(repr(leo))
# <Student(3) Junior 工学 name="leo">
```

## ⚠️须知

在Django框架下，新模型继承ReprMixin后 `makemigrations` 产生的迁移文件中， `CreateModel` 的 `bases` 参数会引入 zeraora，为避免日后潜在的兼容性问题，请删除迁移文件中对 zeraora 的导入以及 `bases` 实参中的ReprMixin。

```Python
# Generated by Django 4.1.8 on 2023-05-04 16:01

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import zeraora.utils  # 删除这一行


class Migration(migrations.Migration):
    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='MyModel',
            fields=[
                ('id', models.BigIntegerField(primary_key=True, serialize=False, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='修改时间')),
            ],
            options={
                'abstract': False,
            },
            bases=(zeraora.ReprMixin, models.Model),  # 删除这一行
        ),
    ]
```

## 底层

重写 `_obtain_attrs()` 方法可以实现控制 `AttributeMeta` 的行为；  
重写 `_obtain_tags()` 方法可以实现控制 `TagMeta` 的行为；  
重写 `_obtain_pk()` 方法可以改变自动读取 `pk` 或 `id` 属性的行为；  
重写 `_obtain_kls()` 方法可以改变被展示的类名。

代码框架：

```Python
from zeraora.utils import ReprMixin

class MyObject(ReprMixin):

    # 业务代码……

    class TagMeta:
        pass

    class AttributeMeta:
        pass

    def __repr__(self) -> str:
        kls = self._obtain_kls()
        pkv = self._obtain_pk()
        tags = self._obtain_tags()
        attrs = self._obtain_attrs()
        content = (
                (f'({pkv})' if pkv else '') +
                (f' {tags}' if tags else '') +
                (f' {attrs}' if attrs else '')
        )
        return f'<{kls}{content}>'

    def _obtain_kls(self) -> str:
        pass

    def _obtain_pk(self) -> str:
        pass

    def _obtain_tags(self) -> str:
        pass

    def _obtain_attrs(self) -> str:
        pass
```

